<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Burger Shot - Staff Meals</title>

  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #fff4d6;
      margin: 0;
      display: flex;
      min-height: 100vh;
      color: #333;
    }
    .sidebar {
      background-color: #c82333;
      width: 220px;
      color: white;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar h2 {
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 2rem;
      text-align: center;
      user-select: none;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 0.75rem 0.5rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.3s;
      user-select: none;
    }
    .sidebar a:hover, .sidebar a.active {
      background-color: #a71d2a;
      text-decoration: none;
    }

    main {
      flex-grow: 1;
      padding: 2rem 3rem;
      background-color: #fff4d6;
      overflow-y: auto;
    }

    h1 {
      color: #c82333;
      font-weight: 700;
      margin-bottom: 2rem;
      user-select: none;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      font-weight: 700;
      user-select: none;
      display: block;
      margin-bottom: 0.3rem;
    }

    select {
      width: 100%;
      padding: 0.5rem;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      user-select: text;
      appearance: none;
      background: white url("data:image/svg+xml,%3Csvg fill='none' stroke='%23333' stroke-width='2' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 10px center;
      background-size: 1em;
      cursor: pointer;
      outline: none;
    }

    button {
      background-color: #c82333;
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      margin-top: 1rem;
      display: inline-block;
    }
    button:hover {
      background-color: #a71d2a;
    }

    #notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #c82333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      display: none;
      z-index: 1000;
      max-width: 90vw;
      text-align: center;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>üçî Burger Shot</h2>
    <nav>
      <ul class="list-unstyled">
        <li><a href="home.html">üè† Home</a></li>
        <li><a href="register.html">üñãÔ∏è Register</a></li>
        <li><a href="orders.html">üìã Orders</a></li>
        <li><a href="inventory.html">üì¶ Inventory</a></li>
        <li><a href="market.html">üè™ Market Run</a></li>
        <li><a href="staffmeals.html" class="active">üçΩÔ∏è Staff Meals</a></li>
        <li><a href="loyalty.html">üéÅ Customers</a></li>
      </ul>
    </nav>
  </aside>

  <main>
    <h1>üçΩÔ∏è Staff Meals</h1>

    <div class="form-group">
      <label for="employeeSelect">Select Employee</label>
      <select id="employeeSelect" required>
        <option value="" disabled selected>Select your name</option>
        <option value="Savannah">Savannah</option>
        <option value="Munch">Munch</option>
      </select>
    </div>

    <div class="form-group">
      <label for="foodSelect">Select Food Item</label>
      <select id="foodSelect" aria-label="Food item selection">
        <option value="">-- None --</option>
        <option value="Bleeder Burger">Bleeder Burger</option>
        <option value="Freedom Fries">Freedom Fries</option>
      </select>
      <label for="foodQty">Quantity (max 5)</label>
      <select id="foodQty" aria-label="Food quantity">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <div class="form-group">
      <label for="drinkSelect">Select Drink Item</label>
      <select id="drinkSelect" aria-label="Drink item selection">
        <option value="">-- None --</option>
        <option value="Grill Cola">Grill Cola</option>
      </select>
      <label for="drinkQty">Quantity (max 5)</label>
      <select id="drinkQty" aria-label="Drink quantity">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>

    <button id="submitMeal">Submit Staff Meal</button>

  </main>

  <div id="notification"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      addDoc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Firebase config (replace with your config if needed)
    const firebaseConfig = {
      apiKey: "AIzaSyBgsHAYXZeLIv-vC0LCHbNHjOTrZOq3GBA",
      authDomain: "burgershotorders.firebaseapp.com",
      projectId: "burgershotorders",
      storageBucket: "burgershotorders.appspot.com",
      messagingSenderId: "244133569976",
      appId: "1:244133569976:web:0dcca3439958188439db4d",
      measurementId: "G-2X69N31D9Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const inventoryDocRef = doc(db, "inventory", "current");
    const staffMealsCollection = collection(db, "staff_meals");

    const UNIT_PER_PACK = 5;

    function showNotification(message, duration = 4000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      notification.style.opacity = '1';

      if (showNotification.timeoutId) clearTimeout(showNotification.timeoutId);

      showNotification.timeoutId = setTimeout(() => {
        notification.style.transition = 'opacity 0.5s ease';
        notification.style.opacity = '0';

        notification.addEventListener('transitionend', () => {
          notification.style.display = 'none';
          notification.style.transition = '';
        }, { once: true });
      }, duration);
    }

    async function getInventory() {
      const docSnap = await getDoc(inventoryDocRef);
      if (docSnap.exists()) {
        return docSnap.data();
      } else {
        return {};
      }
    }

    async function submitStaffMeal() {
      const employee = document.getElementById('employeeSelect').value;
      const foodItem = document.getElementById('foodSelect').value;
      const foodQty = parseInt(document.getElementById('foodQty').value);
      const drinkItem = document.getElementById('drinkSelect').value;
      const drinkQty = parseInt(document.getElementById('drinkQty').value);

      if (!employee) {
        showNotification("Please select your name.");
        return;
      }

      const foodSelected = foodItem !== "" && foodQty > 0;
      const drinkSelected = drinkItem !== "" && drinkQty > 0;

      if (!foodSelected && !drinkSelected) {
        showNotification("Please select at least one food or drink with quantity.");
        return;
      }

      if (foodQty > 5 || drinkQty > 5) {
        showNotification("Quantity per item cannot exceed 5.");
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const docSnap = await transaction.get(inventoryDocRef);
          if (!docSnap.exists()) {
            throw "Inventory document does not exist!";
          }
          const inventory = docSnap.data();

          let neededBuns = 0,
              neededPatties = 0,
              neededChilliPowder = 0,
              neededPotato = 0,
              neededSugar = 0,
              neededCornSyrup = 0;

          if (foodSelected) {
            if (foodItem === "Bleeder Burger") {
              neededBuns = foodQty;
              neededPatties = foodQty;
            } else if (foodItem === "Freedom Fries") {
              neededChilliPowder = foodQty;
              neededPotato = foodQty;
            }
          }

          if (drinkSelected) {
            neededSugar = drinkQty;
            neededCornSyrup = drinkQty;
          }

          // Check if inventory has enough
          const missing = [];
          if ((inventory.burger_buns || 0) < neededBuns) missing.push("Burger Buns");
          if ((inventory.burger_patties || 0) < neededPatties) missing.push("Burger Patties");
          if ((inventory.chilli_powder || 0) < neededChilliPowder) missing.push("Chilli Powder Seasoning");
          if ((inventory.potato || 0) < neededPotato) missing.push("Potato Sack");
          if ((inventory.sugar || 0) < neededSugar) missing.push("Sugar Packs");
          if ((inventory.corn_syrup || 0) < neededCornSyrup) missing.push("Corn Syrup Bottles");

          if (missing.length > 0) {
            throw `Missing ingredients: ${missing.join(", ")}`;
          }

          // Deduct ingredients
          const updatedInventory = { ...inventory };
          updatedInventory.burger_buns = (updatedInventory.burger_buns || 0) - neededBuns;
          updatedInventory.burger_patties = (updatedInventory.burger_patties || 0) - neededPatties;
          updatedInventory.chilli_powder = (updatedInventory.chilli_powder || 0) - neededChilliPowder;
          updatedInventory.potato = (updatedInventory.potato || 0) - neededPotato;
          updatedInventory.sugar = (updatedInventory.sugar || 0) - neededSugar;
          updatedInventory.corn_syrup = (updatedInventory.corn_syrup || 0) - neededCornSyrup;

          transaction.update(inventoryDocRef, updatedInventory);

          // Add staff meal record
          transaction.set(doc(staffMealsCollection), {
            employee,
            foodItem: foodSelected ? foodItem : null,
            foodQty: foodSelected ? foodQty : 0,
            drinkItem: drinkSelected ? drinkItem : null,
            drinkQty: drinkSelected ? drinkQty : 0,
            timestamp: new Date().toISOString()
          });
        });

        showNotification("Staff meal recorded and inventory updated!");

        // Reset form
        document.getElementById('employeeSelect').value = "";
        document.getElementById('foodSelect').value = "";
        document.getElementById('foodQty').value = "0";
        document.getElementById('drinkSelect').value = "";
        document.getElementById('drinkQty').value = "0";
      } catch (error) {
        console.error(error);
        showNotification(typeof error === "string" ? error : "Failed to submit staff meal.");
      }
    }

    document.getElementById('submitMeal').addEventListener('click', submitStaffMeal);
  </script>
</body>
</html>
